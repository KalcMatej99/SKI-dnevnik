<!--

  Author: Matej Kalc

  team.html is needed the view a specific team.
  It can navigate to home.html, account.html and teams.html.

-->

<!DOCTYPE html>
<head lang="en">
    <title>SKI Dnevnik</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <script src="./javascripts/base.js"></script>
</head>
<body style="background-size: cover;">
  <nav class="navbar navbar-inverse">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">SKI Dnevnik</a>
      </div>
      <ul class="nav navbar-nav">
        <li><a href="home.html">Koledar</a></li>
        <li class="active"><a href="teams.html">Skupine</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
          <li><a href="account.html"><span class="glyphicon glyphicon-user"></span> Account</a></li>
        </ul>
    </div>
  </nav>
  <div class="container">
    <h1 id="teamName">Ime skupine</h1>
    <div id="teamsList"class="list-group">
        <a class="list-group-item">
            <h4 class="list-group-item-text">Treningi: <h4 id="trainingsNumber">0</h4></h4> 
          </a>
        <a class="list-group-item">
            <h4 class="list-group-item-text">Tekmovalci: <h4 id="racersNumber">0</h4></h4> 
         </a>
        <br>
    </div>
    <h3>Tekmovalci</h3><div class="row">
      <button data-toggle="modal" data-target="#newRacerModal"
      class="col-sm-1 btn btn-primary" style="margin-right: 10px; margin-left: 10px">+</button>
    </div>
    <div class="modal fade" id="newRacerModal" role="dialog">
      <div class="modal-dialog">
      
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Nov tekmovalec</h4>
          </div>
          <div class="modal-body">
              <form class="form-horizontal">
                <div class="form-group">
                  <label class="control-label col-sm-2" for="team">Ime tekmovalca:</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control" id="racerFirstname">
                  </div>
                </div>
                <br>
                <div class="form-group">
                  <label class="control-label col-sm-2" for="team">Priimek tekmovalca:</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control" id="racerLastname">
                  </div>
                </div>
                <br>
                <div class="form-group">
                    <label class="control-label col-sm-2">Spol:</label>
                    <div class="col-sm-10">
                      <div class="checkbox">
                        <label><input type="checkbox" name="remember" id="racerMaleCheckbox"> M</label>
                      </div>
                      <div class="checkbox">
                        <label><input type="checkbox" name="remember" id="racerFemaleCheckbox"> F</label>
                      </div>
                    </div>
                  </div>
                <div class="form-group">
                  <label class="control-label col-sm-2">Datum rojstva:</label>
                  <div class="col-sm-10">
                    <input type="date" id="racerBirth">
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-sm-2">Opis:</label>
                  <div class="col-sm-10">
                    <textarea rows="4" cols="50" id="racerDescription" placeholder="Napisi napake tekmovalca, opis je opcijski"></textarea>
                  </div>
                </div>
              </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" onclick="saveNewRacer()" data-dismiss="modal">Shrani</button>
          </div>
        </div>
        
      </div>
    </div>
    <div id="racersList"class="list-group">
      <br>
    </div>
    <h3>Treningi</h3>
    <div class="row">
      <button data-toggle="modal" data-target="#newTrainingModal"
      class="col-sm-1 btn btn-primary" style="margin-right: 10px; margin-left: 10px">+</button>
      <button onclick="removeAllTrainings()" class="col-sm-2 btn btn-danger">Izbrisi vse</button>
    </div>
    <div class="modal fade" id="newTrainingModal" role="dialog">
      <div class="modal-dialog">
      
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Nov trening</h4>
          </div>
          <div class="modal-body">
              <form class="form-horizontal">
                <div class="form-group">
                  <label class="control-label col-sm-2" for="team">Ime treninga:</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control" id="trainingName" name="trainingName">
                  </div>
                </div>
                <br>
                <div class="form-group">
                    <label class="control-label col-sm-2">Lokacija:</label>
                    <div class="col-sm-10">
                      <input type="text" class="form-control" id="trainingLocation" placeholder="" name="trainingLocation">
                    </div>
                  </div>
                <div class="form-group">
                  <label class="control-label col-sm-2">Datum:</label>
                  <div class="col-sm-10">
                    <input type="date" name="trainingDate" id="trainingDate">
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-sm-2">Opis:</label>
                  <div class="col-sm-10">
                    <textarea rows="4" cols="50" id="trainingDescription"></textarea>
                  </div>
                </div>
              </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" onclick="saveNewTraining()" data-dismiss="modal">Shrani</button>
          </div>
        </div>
        
      </div>
    </div>
    <div id="trainingsList"class="list-group">
      <br>
    </div>
  </div>
</body>

<script>

var teamid;

$(document).ready(function () {

  //Get teamid from url as parameter
  var url_string = window.location.href;
  var url = new URL(url_string);
  teamid = url.searchParams.get("teamid");

  getUser(function() {
    //Load user data
    setDateToToday();
    setMaxDateToToday();
    loadTrainings(teamid);
    loadRacers(teamid);
    loadNumberOfRacers(teamid);
  });
  
});

//This function loads the trainings in the page
function loadTrainings(teamid) {
  trainingsList.innerHTML = "<br>";
  $.get("/team/trainings", {id: teamid}, function(trainings) {
    var trainingsNumber = document.getElementById("trainingsNumber");
    trainingsNumber.innerHTML = trainings.length;
    var trainingsList = document.getElementById("trainingsList");
    trainings.forEach(training => {
      trainingsList.innerHTML += '<a id="listItem' + training.id + '" href="#" onclick="navigateToTraining(' + training.id + ')" class="clearfix list-group-item">\
            <h2 class="list-group-item-heading"> ' + training.name + ' </h2>\
            <span class="pull-right"> \
              <button type="button" class="btn btn-danger" onclick="removeTraining(' + training.id + '); event.stopPropagation();">Zbriši</button>\
              </span>\
            <h4 class="list-group-item-text">' + training.location + ' - ' + training.date + '</h4> \
            <h4 class="list-group-item-text">' + training.description + '</h4> \
          </a>\
          <br>';
    });
  });
}

//This function writes the number of racers in the page
function loadNumberOfRacers(teamid) {
  $.get("/team/data", {id: teamid}, function(data) {
    var teamName = document.getElementById("teamName");
    teamName.innerHTML = data["name"];
  });
}

//This function is needed to navigate to training.ejs
function navigateToTraining(trainingid) {
  window.href.location = "training.html?trainingid=" + trainingid;
}

function removeTraining(trainingid) {
  $.post("/training/delete", {id: trainingid}, function(err){
    if(err){
      alert(err);
      return;
    } else {
      var listItem = document.getElementById("listItem" + trainingid);
      listItem.parentNode.removeChild(listItem);
    }
  });
}

//This function saves new trainings in db and displays them
function saveNewTraining() {
  var trainingName = document.getElementById("trainingName").value;
  var trainingLocation = document.getElementById("trainingLocation").value;
  var trainingDate = document.getElementById("trainingDate").value;
  var trainingDescription = document.getElementById("trainingDescription").value;
  document.getElementById("trainingName").value = "";
  document.getElementById("trainingLocation").value = "";
  document.getElementById("trainingDate").value = "";
  document.getElementById("trainingDescription").value = "";

  //Check if data is missing
  if(trainingName == "" || trainingLocation == "" || trainingDate == "" || trainingDescription == "") {
    alert("Prosim izpopolni vse zazeljene podatke");
    return;
  }

  //Post server save new team
  $.post("/training/save", {name: trainingName, location: trainingLocation, date: trainingDate, 
    description: trainingDescription, teamid: teamid, weather:null}, function(err) {
    if(err) {
      alert(err);
    } else {
      //Load teams
      loadTrainings(teamid);
    }
  });
}

//Nastavi datum v modal za nov traning na danasnji datum
function setDateToToday(){
  var today = new Date();
  document.getElementById("trainingDate").value = today;
}

//Nastavi max datum v modal za nov traning na danasnji datum
function setMaxDateToToday(){
  var today = new Date();
  document.getElementById("trainingDate").max = today;
}

function saveNewRacer() {
  var racerFirstname = document.getElementById("racerFirstname").value;
  var racerLastname = document.getElementById("racerLastname").value;
  var racerBirth = document.getElementById("racerBirth").value;
  var racerDescription = document.getElementById("racerDescription").value;
  var maleCheckbox = document.getElementById("racerMaleCheckbox").checked;
  var femaleCheckbox = document.getElementById("racerFemaleCheckbox").checked;
  var racerGender;

  if(maleCheckbox) {
    racerGender = 1;
  }
  if(femaleCheckbox) {
    racerGender = 2;
  }
  document.getElementById("racerFirstname").value = "";
  document.getElementById("racerLastname").value = "";
  document.getElementById("racerBirth").value = new Date();
  document.getElementById("racerDescription").value = "";
  document.getElementById("racerMaleCheckbox").checked = true;
  document.getElementById("racerFemaleCheckbox").checked = false;

  //Check if data is missing
  if(racerFirstname == "" || racerLastname == "" || racerBirth == "" || racerGender == "") {
    alert("Prosim izpopolni vse zazeljene podatke");
    return;
  }

  //Post server save new team
    console.log(racerFirstname);
  $.post("/racer/save", {firstname: racerFirstname, lastname: racerLastname, 
    birth: racerBirth, description: racerDescription, 
    gender: racerGender, teamid: teamid}, function(err) {
    if(err) {
      alert(err);
    } else {
      //Load teams
      loadRacers(teamid);
    }
  });
}

function loadRacers(teamid) {
  $.get("/team/racers", {id: teamid}, function(racers){
    var racersNumber = document.getElementById("racersNumber");
    racersNumber.innerHTML = racers.length;
    var racersList = document.getElementById("racersList");
    racers.forEach(racer => {
      var gender = racer.gender == 1 ? "M" : "F";
      racersList.innerHTML += '<a id="racersListItem' + racer.id + '" class="clearfix list-group-item">\
            <h2 class="list-group-item-heading"> ' + racer.firstname + " " + racer.lastname + ' </h2>\
            <span class="pull-right"> \
              <button type="button" class="btn btn-danger" onclick="removeRacer(' + racer.id + '); event.stopPropagation();">Zbriši</button>\
              </span>\
            <h4 class="list-group-item-text">' + gender + ' - ' + racer.birth + '</h4> \
            <h4 class="list-group-item-text">' + racer.description + '</h4> \
          </a>\
          <br>';
    });
  }); 
}

function removeRacer(racerid) {
  $.post("/racer/delete", {id: racerid}, function(err){
    if(err){
      alert(err);
    } else {
      var listItem = document.getElementById("racersListItem" + racerid);
      listItem.parentNode.removeChild(listItem);
      var racersNumber = document.getElementById("racersNumber");
      racersNumber.innerHTML =- 1;
    }
  })
}


</script>
</html>