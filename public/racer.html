<!--

  Author: Matej Kalc

  racer.html is needed the view a specific racer.
  It can navigate to home.html, account.html and teams.html.

-->

<!DOCTYPE html>
<head lang="en">
    <title>SKI Dnevnik</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <script src="./javascripts/base.js"></script>
</head>
<body style="background-size: cover;">
  <nav class="navbar navbar-inverse">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">SKI Dnevnik</a>
      </div>
      <ul class="nav navbar-nav">
        <li><a href="home.html">Koledar</a></li>
        <li class="active"><a href="teams.html">Skupine</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
          <li><a href="account.html"><span class="glyphicon glyphicon-user"></span> Account</a></li>
        </ul>
    </div>
  </nav>
  <div class="container">
    <h1 id="racerName">Ime tekmovalca</h1>
    <div id="racerList"class="list-group">
        <a class="list-group-item">
          <h4 class="list-group-item-text"><h4 id="racerGenderAndBirth"></h4></h4> 
        </a>
        <a class="list-group-item">
            <h4 class="list-group-item-text"><h4 id="racerTeam"></h4></h4> 
        </a>
        <a class="list-group-item">
          <h4 class="list-group-item-text">Treningi: <h4 id="trainingsNumber">0</h4></h4> 
        </a>
        <br>
    </div>
    <h3>Treningi</h3>
    <div id="trainingsList"class="list-group">
      <br>
    </div>
    <h3>Tehnične napake</h3>
    <div class="row">
      <button onclick="newMistakeButtonClicked()" data-toggle="modal" data-target="#newMistakeModal"
      class="col-sm-1 btn btn-primary" style="margin-right: 10px; margin-left: 10px">+</button>
    </div>
    <div class="modal fade" id="newMistakeModal" role="dialog">
      <div class="modal-dialog">
      
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Nova tehnična napaka</h4>
          </div>
          <div class="modal-body">
              <form class="form-horizontal">
                <div class="form-group">
                  <label class="control-label col-sm-2" for="team">Ime/opis napake:</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control" id="mistakeName">
                  </div>
                </div>
                <div class="form-group">
                  <label class="control-label col-sm-2">Datum začetka:</label>
                  <div class="col-sm-10">
                    <input type="date" id="mistakeStartDate">
                  </div>
                </div>
              </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" onclick="saveNewMistake()" data-dismiss="modal">Shrani</button>
          </div>
        </div>
        
      </div>
    </div>
    <div id="mistakesList"class="list-group">
      <br>
    </div>
    <div class="modal fade" id="endMistakeModal" role="dialog">
      <div class="modal-dialog">
      
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Tekmovalec je odpravil napako</h4>
          </div>
          <div class="modal-body">
              <form class="form-horizontal">
                <div class="form-group">
                  <label class="control-label col-sm-2">Datum:</label>
                  <div class="col-sm-10">
                    <input type="date" id="mistakeEndDate">
                  </div>
                </div>
              </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" onclick="endMistake()" data-dismiss="modal">Shrani</button>
          </div>
        </div>
        
      </div>
    </div>
  </div>
</body>

<script>

var teamid;
var racerid;
var racer;
var trainings;
var mistakes;

var currentEndMistakeid;

$(document).ready(function () {

  //Get teamid from url as parameter
  var url_string = window.location.href;
  var url = new URL(url_string);
  racerid = url.searchParams.get("racerid");

  checkIfRacerExists(racerid, function(exists) {
    if(exists) {
      getUser(function() {
        //Load user data
        loadRacer();
        loadTrainings();
        loadMistakes();
      });
    } else {
      navigateToNotFound();
    }
  });
  
});

function loadRacer() {
    $.get("/racer/data", {id: racerid}, function(data) {
        racer = data;
        
        document.getElementById("racerName").innerHTML = racer.firstname + " " + racer.lastname;
        document.getElementById("racerGenderAndBirth").innerHTML = (racer.gender == 1 ? "M" : "F") + " - " + parseDate(racer.birth);

        $.get("/team/data", {id: racer.teamid}, function(data) {
            document.getElementById("racerTeam").innerHTML = data.name;
        });
    });
}

//This function loads the trainings in the page
function loadTrainings() {
  $.get("/racer/trainings", {id: racerid}, function(trainingsArray) {
    trainings = trainingsArray;
    displayTrainings();
  });
}

function displayTrainings() {
  var trainingsNumber = document.getElementById("trainingsNumber");
  trainingsNumber.innerHTML = trainings.length;
  var trainingsList = document.getElementById("trainingsList");
  trainingsList.innerHTML = "<br>";
  trainings.forEach(training => {
      trainingsList.innerHTML += '<a id="listItem' + training.id + '" class="clearfix list-group-item">\
          <h2 class="list-group-item-heading"> ' + training.name + ' </h2>\
          <h4 class="list-group-item-text">' + training.location + ' - ' + parseDate(training.startdate) + '</h4> \
          <h4 class="list-group-item-text">' + training.description + '</h4> \
        </a>\
        <br>';
  });
}

function loadMistakes() {
  $.get("/racer/mistakes", {id: racerid}, function(mistakesArray) {
    mistakes = mistakesArray;
    displayMistakes();
  });
}

function displayMistakes() {
  var mistakesList = document.getElementById("mistakesList");
  mistakesList.innerHTML = "<br>";
  
  mistakes.forEach(mistake => {
    mistakesList.innerHTML += '<a id="listItem' + mistake.id + '" ' + (mistake.enddate ? "" : ('data-toggle="modal" data-target="#endMistakeModal" onclick="endMistakeClicked(' + mistake.id + ')"')) + ' \
          class="clearfix list-group-item">\
          <h2 class="list-group-item-heading"> ' + mistake.name + ' </h2>\
          <span class="pull-right"> \
            <button type="button" class="btn btn-danger" onclick="removeMistake(' + mistake.id + '); event.stopPropagation();">Zbriši</button>\
            </span>\
          <h4 class="list-group-item-text"> Start: ' + parseDate(mistake.creationdate) + '</h4> \
          <h4 class="list-group-item-text"> Konec: ' + (mistake.enddate ? parseDate(mistake.enddate) : "Napaka ni bila še odpravljena") + '</h4> \
        </a>\
        <br>';
  });
}



function saveNewMistake() {
  var mistakeName = document.getElementById("mistakeName").value;
  var mistakeStartDate = document.getElementById("mistakeStartDate").value;
  
  document.getElementById("mistakeName").value = "";
  document.getElementById("mistakeStartDate").value = new Date();

  //Check if data is missing
  if(mistakeName == "") {
    alert("Prosim izpopolni vse zazeljene podatke");
    return;
  }

  //Post server save new team
  $.post("/mistake/save", {name: mistakeName, startDate: mistakeStartDate, racerid:racerid}, function(err) {
    if(err) {
      alert(err);
    } else {
      loadMistakes();
    }
  });
}

function removeMistake(mistakeid) {
  $.post("/mistake/delete", {id: mistakeid}, function(err){
      if(err){
          alert(err);
      } else {
          loadMistakes();
      }
  });
}

function newMistakeButtonClicked() {
  document.getElementById("mistakeStartDate").value = new Date().toDateInputValue();
}

function endMistake() {
  var mistakeEndDate = document.getElementById("mistakeEndDate").value;

  console.log(currentEndMistakeid + " " + mistakeEndDate);

  $.post("/mistake/addEndDate", {id: currentEndMistakeid, endDate: mistakeEndDate}, function(err) {
    if(err) {
      alert(err);
    } else {
      loadMistakes();
    }
  });

  currentEndMistakeid = null;
}
function endMistakeClicked(mistakeid) {
  currentEndMistakeid = mistakeid;
}

</script>
</html>